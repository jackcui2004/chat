<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç§äººåŠ å¯†é€šé“</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        /* æç®€é»‘å®¢é£ UI */
        body { margin: 0; padding: 0; background-color: #0f0f0f; color: #00ff41; font-family: 'Courier New', Courier, monospace; overflow: hidden; display: flex; flex-direction: column; height: 100vh; }
        
        /* é¡¶éƒ¨æ§åˆ¶æ  */
        .header { padding: 10px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; background: #1a1a1a; z-index: 100; }
        .logo { font-weight: bold; font-size: 1.2rem; letter-spacing: 2px; }
        .controls { display: flex; gap: 10px; }
        input { background: #222; border: 1px solid #444; color: #fff; padding: 5px 10px; border-radius: 4px; font-family: inherit; }
        button { background: #004400; color: #00ff41; border: 1px solid #00ff41; padding: 5px 15px; cursor: pointer; font-family: inherit; transition: all 0.2s; }
        button:hover { background: #00ff41; color: #000; }
        
        /* ä¸»ä½“å¸ƒå±€ */
        .main-container { display: flex; flex: 1; overflow: hidden; position: relative; }
        
        /* è§†é¢‘åŒºåŸŸ */
        .video-area { flex: 3; display: flex; flex-wrap: wrap; align-content: center; justify-content: center; gap: 10px; padding: 10px; background: #000; overflow-y: auto; }
        video { max-width: 45%; max-height: 45%; border: 1px solid #333; border-radius: 4px; background: #111; object-fit: cover; }
        /* å±å¹•å…±äº«æ—¶æ”¾å¤§ */
        video.screen-share { width: 90%; height: 80%; max-width: none; max-height: none; }

        /* èŠå¤©åŒºåŸŸ (é»˜è®¤éšè—ï¼Œç‚¹å‡»å±•å¼€) */
        .chat-area { flex: 1; max-width: 300px; background: #111; border-left: 1px solid #333; display: flex; flex-direction: column; }
        .messages { flex: 1; padding: 10px; overflow-y: auto; font-size: 0.9rem; }
        .msg { margin-bottom: 8px; word-break: break-all; }
        .msg.sys { color: #666; font-style: italic; }
        .msg.me { color: #00ff41; }
        .msg.peer { color: #00ccff; }
        .input-box { padding: 10px; border-top: 1px solid #333; display: flex; }
        .input-box input { flex: 1; }

        /* çŠ¶æ€æç¤º */
        #my-id-display { color: #ffeb3b; font-weight: bold; cursor: pointer; text-decoration: underline; }
        
        /* æ‰‹æœºé€‚é… */
        @media (max-width: 768px) {
            .video-area { flex-direction: column; justify-content: flex-start; }
            video { max-width: 100%; width: 100%; height: auto; }
            .chat-area { display: none; position: absolute; right: 0; top: 0; bottom: 0; width: 80%; z-index: 50; border-left: 1px solid #00ff41; }
            .chat-area.active { display: flex; }
            .controls input { width: 80px; }
        }
    </style>
</head>
<body>

<div class="header">
    <div class="logo">ENCRYPTED_LINK</div>
    <div style="font-size: 0.8rem;">
        æˆ‘çš„ID: <span id="my-id-display" onclick="copyId()">è·å–ä¸­...</span>
    </div>
    <div class="controls">
        <input type="text" id="target-id" placeholder="å¯¹æ–¹ID">
        <button onclick="connectPeer()">è¿æ¥</button>
        <button onclick="shareScreen()">ğŸ“º å…±äº«å±å¹•</button>
        <button onclick="toggleChat()" style="border-color: #00ccff; color: #00ccff;">ğŸ’¬ èŠå¤©</button>
    </div>
</div>

<div class="main-container">
    <div class="video-area" id="video-grid">
        <video id="local-video" muted autoplay playsinline></video>
    </div>
    
    <div class="chat-area" id="chat-panel">
        <div class="messages" id="msgs">
            <div class="msg sys">>>> ç³»ç»Ÿå°±ç»ªã€‚é“¾æ¥å»ºç«‹åï¼Œæ•°æ®ç‚¹å¯¹ç‚¹åŠ å¯†ä¼ è¾“ã€‚</div>
            <div class="msg sys">>>> è­¦å‘Šï¼šåˆ·æ–°é¡µé¢å°†ä¸¢å¤±æ‰€æœ‰èŠå¤©è®°å½•ã€‚</div>
        </div>
        <div class="input-box">
            <input type="text" id="chat-input" placeholder="è¾“å…¥æ¶ˆæ¯..." onkeypress="if(event.key==='Enter') sendMsg()">
            <button onclick="sendMsg()">></button>
        </div>
    </div>
</div>

<script>
    // åˆå§‹åŒ– PeerJS (ä½¿ç”¨å®˜æ–¹å…è´¹æœåŠ¡å™¨)
    const peer = new Peer();
    let myStream = null;
    let peers = {}; // å­˜å‚¨æ‰€æœ‰è¿æ¥

    // DOM å…ƒç´ 
    const videoGrid = document.getElementById('video-grid');
    const msgs = document.getElementById('msgs');
    
    // 1. å¯åŠ¨ï¼šè·å–æœ¬åœ°æ‘„åƒå¤´
    navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(stream => {
        myStream = stream;
        const localVideo = document.getElementById('local-video');
        localVideo.srcObject = stream;
        localVideo.muted = true; // è‡ªå·±é™éŸ³
    }).catch(err => log("ç³»ç»Ÿ", "æ— æ³•è·å–æ‘„åƒå¤´æƒé™ï¼Œä»…èƒ½è§‚çœ‹", "sys"));

    // 2. Peer å¼€å¯æˆåŠŸ
    peer.on('open', id => {
        document.getElementById('my-id-display').innerText = id;
        log("ç³»ç»Ÿ", "ä½ çš„å®‰å…¨IDå·²ç”Ÿæˆã€‚ç‚¹å‡»é¡¶éƒ¨IDå¤åˆ¶å‘ç»™æœ‹å‹ã€‚", "sys");
    });

    // 3. è¢«å‘¼å«ï¼ˆè§†é¢‘ï¼‰
    peer.on('call', call => {
        if(confirm("æ£€æµ‹åˆ°æ¥å…¥è¯·æ±‚ï¼Œæ˜¯å¦æ¥é€šï¼Ÿ")) {
            call.answer(myStream);
            handleStream(call);
        }
    });

    // 4. è¢«è¿æ¥ï¼ˆæ–‡å­—ï¼‰
    peer.on('connection', conn => {
        setupConn(conn);
    });

    // --- ä¸»åŠ¨åŠŸèƒ½ ---

    // è¿æ¥åˆ«äºº
    function connectPeer() {
        const id = document.getElementById('target-id').value.trim();
        if(!id) return alert("è¯·è¾“å…¥å¯¹æ–¹ID");
        
        // å‘èµ·è§†é¢‘
        const call = peer.call(id, myStream);
        handleStream(call);
        
        // å‘èµ·æ–‡å­—è¿æ¥
        const conn = peer.connect(id);
        setupConn(conn);
    }

    // å…±äº«å±å¹•
    async function shareScreen() {
        try {
            const screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
            const screenTrack = screenStream.getVideoTracks()[0];
            
            // æ‰¾åˆ°æ‰€æœ‰çš„è§†é¢‘å‘é€å™¨å¹¶æ›¿æ¢
            for (let id in peers) {
                if(peers[id].call) {
                    const sender = peers[id].call.peerConnection.getSenders().find(s => s.track.kind === 'video');
                    sender.replaceTrack(screenTrack);
                }
            }
            
            // å±å¹•å…±äº«ç»“æŸæ—¶æ¢å¤æ‘„åƒå¤´
            screenTrack.onended = () => {
                const videoTrack = myStream.getVideoTracks()[0];
                for (let id in peers) {
                    if(peers[id].call) {
                        const sender = peers[id].call.peerConnection.getSenders().find(s => s.track.kind === 'video');
                        sender.replaceTrack(videoTrack);
                    }
                }
            };
        } catch(e) { console.error(e); }
    }

    // å‘é€æ¶ˆæ¯
    function sendMsg() {
        const input = document.getElementById('chat-input');
        const text = input.value;
        if(!text) return;
        
        // å¹¿æ’­ç»™æ‰€æœ‰äºº
        for(let id in peers) {
            if(peers[id].conn) peers[id].conn.send(text);
        }
        log("æˆ‘", text, "me");
        input.value = '';
    }

    // --- è¾…åŠ©é€»è¾‘ ---

    function handleStream(call) {
        const video = document.createElement('video');
        call.on('stream', stream => {
            // é¿å…é‡å¤æ·»åŠ 
            if(video.srcObject) return;
            video.srcObject = stream;
            video.play();
            videoGrid.appendChild(video);
        });
        call.on('close', () => video.remove());
        peers[call.peer] = { ...peers[call.peer], call: call };
    }

    function setupConn(conn) {
        conn.on('open', () => {
            log("ç³»ç»Ÿ", "å·²è¿æ¥: " + conn.peer, "sys");
            peers[conn.peer] = { ...peers[conn.peer], conn: conn };
        });
        conn.on('data', data => log("å¯¹æ–¹", data, "peer"));
        conn.on('close', () => log("ç³»ç»Ÿ", "å¯¹æ–¹å·²æ–­å¼€", "sys"));
    }

    function log(name, text, type) {
        const div = document.createElement('div');
        div.className = `msg ${type}`;
        div.innerText = `[${name}] ${text}`;
        msgs.appendChild(div);
        msgs.scrollTop = msgs.scrollHeight;
    }

    function copyId() {
        navigator.clipboard.writeText(document.getElementById('my-id-display').innerText);
        alert("IDå·²å¤åˆ¶");
    }

    function toggleChat() {
        const chat = document.getElementById('chat-panel');
        chat.classList.toggle('active');
    }
</script>
</body>
</html>