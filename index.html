<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç§äººé€šè¯</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        /* --- æ‰‹æœºç«¯ä¼˜å…ˆçš„æ ·å¼è®¾è®¡ --- */
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        body { background: #121212; color: #fff; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* ç™»å½•é¡µï¼ˆè®¾ç½®IDï¼‰ */
        #login-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #121212; z-index: 999; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; transition: transform 0.3s ease; }
        .login-box { width: 100%; max-width: 320px; text-align: center; }
        h2 { margin-bottom: 30px; font-weight: 300; letter-spacing: 2px; }
        .input-group { margin-bottom: 20px; text-align: left; }
        label { display: block; color: #888; margin-bottom: 5px; font-size: 14px; }
        input { width: 100%; padding: 15px; background: #222; border: 1px solid #333; color: #fff; border-radius: 12px; font-size: 16px; }
        input:focus { border-color: #007bff; }
        
        .btn-main { width: 100%; padding: 16px; background: #007bff; color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; margin-top: 10px; cursor: pointer; active: scale(0.98); }
        .btn-main:active { background: #0056b3; transform: scale(0.98); }

        /* è§†é¢‘é€šè¯é¡µ */
        #video-screen { flex: 1; display: flex; flex-direction: column; position: relative; display: none; }
        
        /* è§†é¢‘å®¹å™¨ */
        .video-container { flex: 1; position: relative; background: #000; overflow: hidden; display: flex; justify-content: center; align-items: center; }
        
        /* å¯¹æ–¹çš„å¤§ç”»é¢ */
        #remote-video { width: 100%; height: 100%; object-fit: cover; }
        
        /* è‡ªå·±çš„å°ç”»é¢ï¼ˆæ‚¬æµ®ï¼‰ */
        #local-video { position: absolute; right: 20px; top: 20px; width: 100px; height: 140px; background: #222; border-radius: 10px; border: 2px solid rgba(255,255,255,0.2); object-fit: cover; z-index: 10; box-shadow: 0 4px 10px rgba(0,0,0,0.5); transition: all 0.3s; }

        /* åº•éƒ¨æ§åˆ¶æ  */
        .controls { height: 80px; background: rgba(30,30,30,0.9); display: flex; justify-content: space-around; align-items: center; padding-bottom: 10px; backdrop-filter: blur(10px); }
        .btn-icon { width: 50px; height: 50px; border-radius: 50%; border: none; background: #333; color: #fff; font-size: 20px; display: flex; justify-content: center; align-items: center; cursor: pointer; }
        .btn-icon.red { background: #ff3b30; }
        .btn-icon.green { background: #34c759; }
        .btn-icon:active { transform: scale(0.9); }

        /* çŠ¶æ€æç¤º */
        #status-toast { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); padding: 10px 20px; border-radius: 20px; font-size: 14px; pointer-events: none; opacity: 0; transition: opacity 0.3s; z-index: 100; }

        /* èŠå¤©å±‚ */
        #chat-layer { position: absolute; bottom: 80px; left: 0; width: 100%; height: 300px; background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); pointer-events: none; display: flex; flex-direction: column; justify-content: flex-end; padding: 20px; }
        .msg { background: rgba(255,255,255,0.15); padding: 8px 12px; border-radius: 8px; margin-bottom: 8px; max-width: 80%; width: fit-content; font-size: 14px; pointer-events: auto; backdrop-filter: blur(4px); animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .chat-input-box { position: absolute; bottom: 90px; left: 5%; width: 90%; display: none; pointer-events: auto; }
        .chat-input-box input { background: rgba(50,50,50,0.9); border: 1px solid #555; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h2>ğŸ” ç§äººåŠ å¯†è¿çº¿</h2>
            <div class="input-group">
                <label>ç»™è‡ªå·±èµ·ä¸ªçŸ­å (å¦‚: 001)</label>
                <input type="text" id="my-id-input" placeholder="è¾“å…¥ä½ çš„ ID">
            </div>
            <div class="input-group">
                <label>æœ‹å‹çš„çŸ­å (å¦‚: 002)</label>
                <input type="text" id="target-id-input" placeholder="è¾“å…¥å¯¹æ–¹ ID">
            </div>
            <button class="btn-main" onclick="startApp()">è¿›å…¥è¿æ¥</button>
            <p style="margin-top: 15px; color: #666; font-size: 12px;">å¦‚æœè¿ä¸ä¸Šï¼Œè¯·å°è¯•åˆ‡æ¢WiFi/4G</p>
        </div>
    </div>

    <div id="video-screen">
        <div class="video-container">
            <video id="remote-video" autoplay playsinline></video>
            <video id="local-video" autoplay playsinline muted></video>
            <div id="status-toast">ç­‰å¾…è¿æ¥...</div>
            
            <div id="chat-layer" id="messages"></div>
            
            <div class="chat-input-box" id="chat-input-box">
                <input type="text" id="msg-input" placeholder="å‘é€æ¶ˆæ¯..." onkeypress="if(event.key==='Enter') sendMsg()">
            </div>
        </div>

        <div class="controls">
            <button class="btn-icon" onclick="toggleChat()">ğŸ’¬</button>
            <button class="btn-icon green" onclick="callPeer()">ğŸ“</button>
            <button class="btn-icon" onclick="shareScreen()">ğŸ“º</button>
            <button class="btn-icon red" onclick="location.reload()">âŒ</button>
        </div>
    </div>

<script>
    let peer;
    let myStream;
    let currentConn;
    let currentCall;

    // å¢å¼ºç‰ˆç©¿é€æœåŠ¡å™¨åˆ—è¡¨ (å¢åŠ è¿æ¥æˆåŠŸç‡)
    const peerConfig = {
        config: {
            'iceServers': [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' },
                { urls: 'stun:stun.westhawk.co.uk:3478' }
            ]
        },
        debug: 1
    };

    function showToast(text) {
        const t = document.getElementById('status-toast');
        t.innerText = text;
        t.style.opacity = 1;
        setTimeout(() => t.style.opacity = 0, 3000);
    }

    // 1. å¯åŠ¨åº”ç”¨
    function startApp() {
        const myId = document.getElementById('my-id-input').value.trim();
        const targetId = document.getElementById('target-id-input').value.trim();

        if (!myId) return alert("è¯·å…ˆè¾“å…¥ä½ çš„ ID");

        // åˆ‡æ¢ç•Œé¢
        document.getElementById('login-screen').style.transform = 'translateY(-100%)';
        document.getElementById('video-screen').style.display = 'flex';
        
        // ä¿å­˜å¯¹æ–¹IDæ–¹ä¾¿åç»­è°ƒç”¨
        window.targetId = targetId;

        // åˆå§‹åŒ–æ‘„åƒå¤´
        navigator.mediaDevices.getUserMedia({ video: true, audio: true })
            .then(stream => {
                myStream = stream;
                document.getElementById('local-video').srcObject = stream;
                initPeer(myId);
            })
            .catch(err => {
                alert("æ— æ³•è·å–æ‘„åƒå¤´æƒé™ï¼Œè¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸ã€‚");
                initPeer(myId); // å³ä½¿æ²¡æ‘„åƒå¤´ä¹Ÿå°è¯•åˆå§‹åŒ–ï¼Œä¸ºäº†èƒ½çœ‹åˆ«äºº
            });
    }

    function initPeer(id) {
        // ä½¿ç”¨è‡ªå®šä¹‰ ID åˆå§‹åŒ–
        peer = new Peer(id, peerConfig);

        peer.on('open', (id) => {
            showToast("å°±ç»ªï¼ŒID: " + id);
            // å¦‚æœå¡«äº†å¯¹æ–¹IDï¼Œè‡ªåŠ¨å°è¯•è¿æ¥æ–‡å­—é€šé“
            if(window.targetId) connectData(window.targetId);
        });

        peer.on('error', (err) => {
            if(err.type === 'unavailable-id') alert("è¿™ä¸ª ID å·²ç»è¢«å ç”¨äº†ï¼Œæ¢ä¸€ä¸ªå§");
            else showToast("è¿æ¥é”™è¯¯: " + err.type);
        });

        // è¢«å‘¼å«ï¼ˆè§†é¢‘ï¼‰
        peer.on('call', call => {
            if(confirm("æœ‹å‹è¯·æ±‚è§†é¢‘é€šè¯ï¼Œæ¥å¬å—ï¼Ÿ")) {
                call.answer(myStream);
                handleStream(call);
            }
        });

        // è¢«è¿æ¥ï¼ˆæ–‡å­—ï¼‰
        peer.on('connection', conn => {
            setupConn(conn);
        });
    }

    // 2. ä¸»åŠ¨æ‹¨æ‰“
    function callPeer() {
        const id = window.targetId;
        if(!id) return promptInputId();
        
        showToast("æ­£åœ¨å‘¼å« " + id + "...");
        const call = peer.call(id, myStream);
        handleStream(call);
        connectData(id);
    }

    function connectData(id) {
        if(currentConn && currentConn.open) return;
        const conn = peer.connect(id);
        setupConn(conn);
    }

    function promptInputId() {
        const id = prompt("è¯·è¾“å…¥æœ‹å‹çš„ID");
        if(id) {
            window.targetId = id;
            callPeer();
        }
    }

    // 3. å¤„ç†è§†é¢‘æµ
    function handleStream(call) {
        currentCall = call;
        call.on('stream', remoteStream => {
            document.getElementById('remote-video').srcObject = remoteStream;
            showToast("è§†é¢‘å·²è¿æ¥");
            // è§†é¢‘è¿é€šåï¼ŒæŠŠè‡ªå·±çš„å°çª—å£ç§»åˆ°è§’è½
            document.getElementById('local-video').style.display = 'block';
        });
        call.on('close', () => showToast("é€šè¯ç»“æŸ"));
    }

    // 4. å¤„ç†æ–‡å­—æ¶ˆæ¯
    function setupConn(conn) {
        currentConn = conn;
        conn.on('open', () => showToast("æ–‡å­—é€šé“å·²è¿æ¥"));
        conn.on('data', data => {
            if(typeof data === 'string') showMsg(data, false);
        });
    }

    // 5. å±å¹•å…±äº«
    async function shareScreen() {
        if(!currentCall) return alert("è¯·å…ˆå»ºç«‹è§†é¢‘é€šè¯");
        try {
            const screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
            const screenTrack = screenStream.getVideoTracks()[0];
            const sender = currentCall.peerConnection.getSenders().find(s => s.track.kind === 'video');
            sender.replaceTrack(screenTrack);
            
            screenTrack.onended = () => {
                sender.replaceTrack(myStream.getVideoTracks()[0]);
            };
        } catch(e) { console.error(e); }
    }

    // èŠå¤©åŠŸèƒ½
    function toggleChat() {
        const box = document.getElementById('chat-input-box');
        box.style.display = box.style.display === 'block' ? 'none' : 'block';
        if(box.style.display === 'block') document.getElementById('msg-input').focus();
    }

    function sendMsg() {
        const input = document.getElementById('msg-input');
        const text = input.value;
        if(!text) return;
        if(currentConn && currentConn.open) {
            currentConn.send(text);
            showMsg(text, true);
            input.value = '';
        } else {
            showToast("æœªè¿æ¥åˆ°æœ‹å‹");
        }
    }

    function showMsg(text, isMe) {
        const div = document.createElement('div');
        div.className = 'msg';
        div.style.alignSelf = isMe ? 'flex-end' : 'flex-start';
        div.style.background = isMe ? 'rgba(0,123,255,0.6)' : 'rgba(255,255,255,0.15)';
        div.innerText = text;
        document.getElementById('chat-layer').appendChild(div);
        setTimeout(() => div.remove(), 10000); // 10ç§’åæ¶ˆæ¯è‡ªåŠ¨æ¶ˆå¤±
    }
</script>
</body>
</html>
